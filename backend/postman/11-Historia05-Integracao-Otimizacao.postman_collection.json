{
	"info": {
		"_postman_id": "historia05-integracao-otimizacao",
		"name": "História 05 - Integração e Otimização",
		"description": "Testes para História 5: Integração e Otimização - Sprint S2.2\n\nTesta funcionalidades de:\n- Rate Limiting\n- Cache Redis\n- Compressão de resposta\n- Performance otimizada\n- Índices de banco de dados",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Rate Limiting Tests",
			"item": [
				{
					"name": "Test Rate Limiting - Normal User",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200 or 429\", function () {",
									"    pm.expect([200, 429]).to.include(pm.response.code);",
									"});",
									"",
									"pm.test(\"Rate limit headers present\", function () {",
									"    if (pm.response.code === 200) {",
									"        pm.expect(pm.response.headers.has('X-RateLimit-Remaining')).to.be.true;",
									"    }",
									"});",
									"",
									"if (pm.response.code === 429) {",
									"    pm.test(\"Rate limit exceeded message\", function () {",
									"        const jsonData = pm.response.json();",
									"        pm.expect(jsonData.success).to.be.false;",
									"        pm.expect(pm.response.headers.has('X-RateLimit-Retry-After')).to.be.true;",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{userToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/auth/refresh",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"auth",
								"refresh"
							]
						}
					},
					"response": []
				},
				{
					"name": "Test Rate Limiting - Admin User",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Rate limit headers present\", function () {",
									"    pm.expect(pm.response.headers.has('X-RateLimit-Remaining')).to.be.true;",
									"});",
									"",
									"pm.test(\"Admin has higher limit\", function () {",
									"    const remaining = parseInt(pm.response.headers.get('X-RateLimit-Remaining'));",
									"    pm.expect(remaining).to.be.greaterThan(0);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/estatisticas",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"estatisticas"
							]
						}
					},
					"response": []
				},
				{
					"name": "Test Rate Limiting - Report Endpoints",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200 or 429\", function () {",
									"    pm.expect([200, 429]).to.include(pm.response.code);",
									"});",
									"",
									"if (pm.response.code === 200) {",
									"    pm.test(\"Response has data\", function () {",
									"        const jsonData = pm.response.json();",
									"        pm.expect(jsonData.success).to.be.true;",
									"        pm.expect(jsonData.data).to.exist;",
									"    });",
									"}",
									"",
									"if (pm.response.code === 429) {",
									"    pm.test(\"Rate limit for reports is more restrictive\", function () {",
									"        const jsonData = pm.response.json();",
									"        pm.expect(jsonData.success).to.be.false;",
									"        pm.expect(pm.response.headers.has('X-RateLimit-Retry-After')).to.be.true;",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/comissoes?inicio=2024-01-01&fim=2024-12-31",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"comissoes"
							],
							"query": [
								{
									"key": "inicio",
									"value": "2024-01-01"
								},
								{
									"key": "fim",
									"value": "2024-12-31"
								}
							]
						}
					},
					"response": []
				},
				{
					"name": "Burst Test - Multiple Requests",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Response received\", function () {",
									"    pm.expect([200, 429]).to.include(pm.response.code);",
									"});",
									"",
									"// Store response for analysis",
									"const responseCode = pm.response.code;",
									"const remaining = pm.response.headers.get('X-RateLimit-Remaining');",
									"",
									"pm.globals.set('lastResponseCode', responseCode);",
									"pm.globals.set('lastRemaining', remaining || '0');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/estatisticas",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"estatisticas"
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Cache Performance Tests",
			"item": [
				{
					"name": "Cache Miss - First Request",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has statistics data\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data).to.exist;",
									"    pm.expect(jsonData.data.totalContratos).to.exist;",
									"    pm.expect(jsonData.data.vendedoresAtivos).to.exist;",
									"});",
									"",
									"// Store response time for comparison",
									"pm.globals.set('firstRequestTime', pm.response.responseTime);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/estatisticas",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"estatisticas"
							]
						}
					},
					"response": []
				},
				{
					"name": "Cache Hit - Second Request",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has same data structure\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data).to.exist;",
									"    pm.expect(jsonData.data.totalContratos).to.exist;",
									"});",
									"",
									"// Compare response times (cache should be faster)",
									"const firstTime = parseInt(pm.globals.get('firstRequestTime'));",
									"const secondTime = pm.response.responseTime;",
									"",
									"pm.test(\"Cache improves performance\", function () {",
									"    // Cache hit should be faster or at least not significantly slower",
									"    pm.expect(secondTime).to.be.lessThan(firstTime + 100);",
									"});",
									"",
									"console.log(`First request: ${firstTime}ms, Second request: ${secondTime}ms`);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/estatisticas",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"estatisticas"
							]
						}
					},
					"response": []
				},
				{
					"name": "Commission Report Cache Test",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Commission report structure\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data).to.exist;",
									"    pm.expect(jsonData.data.periodo).to.exist;",
									"    pm.expect(jsonData.data.resumo).to.exist;",
									"    pm.expect(jsonData.data.porContrato).to.be.an('array');",
									"});",
									"",
									"pm.test(\"Response time acceptable\", function () {",
									"    pm.expect(pm.response.responseTime).to.be.below(1000);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/comissoes?inicio=2024-01-01&fim=2024-12-31",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"comissoes"
							],
							"query": [
								{
									"key": "inicio",
									"value": "2024-01-01"
								},
								{
									"key": "fim",
									"value": "2024-12-31"
								}
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Performance Tests",
			"item": [
				{
					"name": "Statistics Performance Test",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response time under 500ms\", function () {",
									"    pm.expect(pm.response.responseTime).to.be.below(500);",
									"});",
									"",
									"pm.test(\"Statistics data complete\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.totalContratos).to.be.a('number');",
									"    pm.expect(jsonData.data.vendedoresAtivos).to.be.a('number');",
									"    pm.expect(jsonData.data.contratosPorStatus).to.be.an('object');",
									"    pm.expect(jsonData.data.taxaMediaComissao).to.be.a('number');",
									"});",
									"",
									"console.log(`Statistics response time: ${pm.response.responseTime}ms`);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/estatisticas",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"estatisticas"
							]
						}
					},
					"response": []
				},
				{
					"name": "Commission Report Performance",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response time under 1000ms\", function () {",
									"    pm.expect(pm.response.responseTime).to.be.below(1000);",
									"});",
									"",
									"pm.test(\"Commission report complete\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.periodo).to.exist;",
									"    pm.expect(jsonData.data.resumo).to.exist;",
									"    pm.expect(jsonData.data.resumo.totalComissoes).to.be.a('number');",
									"    pm.expect(jsonData.data.resumo.totalVendas).to.be.a('number');",
									"});",
									"",
									"console.log(`Commission report response time: ${pm.response.responseTime}ms`);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/comissoes?inicio=2024-01-01&fim=2024-12-31",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"comissoes"
							],
							"query": [
								{
									"key": "inicio",
									"value": "2024-01-01"
								},
								{
									"key": "fim",
									"value": "2024-12-31"
								}
							]
						}
					},
					"response": []
				},
				{
					"name": "Expiring Contracts Performance",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response time under 800ms\", function () {",
									"    pm.expect(pm.response.responseTime).to.be.below(800);",
									"});",
									"",
									"pm.test(\"Expiring contracts structure\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.contratos).to.be.an('array');",
									"    pm.expect(jsonData.data.resumo).to.exist;",
									"    pm.expect(jsonData.data.resumo.total).to.be.a('number');",
									"});",
									"",
									"console.log(`Expiring contracts response time: ${pm.response.responseTime}ms`);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/vencendo?dias=30",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"vencendo"
							],
							"query": [
								{
									"key": "dias",
									"value": "30"
								}
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Compression Tests",
			"item": [
				{
					"name": "Test Response Compression",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Content-Type is JSON\", function () {",
									"    pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json');",
									"});",
									"",
									"// Check if compression headers are present (may vary by server config)",
									"const contentEncoding = pm.response.headers.get('Content-Encoding');",
									"if (contentEncoding) {",
									"    pm.test(\"Response is compressed\", function () {",
									"        pm.expect(['gzip', 'deflate', 'br']).to.include(contentEncoding);",
									"    });",
									"}",
									"",
									"pm.test(\"Response has substantial content\", function () {",
									"    const responseSize = pm.response.responseSize;",
									"    pm.expect(responseSize).to.be.greaterThan(100);",
									"});",
									"",
									"console.log(`Response size: ${pm.response.responseSize} bytes`);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							},
							{
								"key": "Accept-Encoding",
								"value": "gzip, deflate, br",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/comissoes?inicio=2024-01-01&fim=2024-12-31",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"comissoes"
							],
							"query": [
								{
									"key": "inicio",
									"value": "2024-01-01"
								},
								{
									"key": "fim",
									"value": "2024-12-31"
								}
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Integration Tests",
			"item": [
				{
					"name": "Full Dashboard Integration",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"All dashboard components working\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    ",
									"    // Statistics data",
									"    pm.expect(jsonData.data.totalContratos).to.be.a('number');",
									"    pm.expect(jsonData.data.vendedoresAtivos).to.be.a('number');",
									"    pm.expect(jsonData.data.contratosPorStatus).to.be.an('object');",
									"    ",
									"    // Financial data",
									"    pm.expect(jsonData.data.receitaProjetadaMes).to.be.a('number');",
									"    pm.expect(jsonData.data.receitaRealizadaMes).to.be.a('number');",
									"    pm.expect(jsonData.data.taxaMediaComissao).to.be.a('number');",
									"    ",
									"    // Expiring contracts",
									"    pm.expect(jsonData.data.contratosVencendo30Dias).to.be.a('number');",
									"});",
									"",
									"pm.test(\"Performance within limits\", function () {",
									"    pm.expect(pm.response.responseTime).to.be.below(500);",
									"});",
									"",
									"pm.test(\"Rate limiting headers present\", function () {",
									"    pm.expect(pm.response.headers.has('X-RateLimit-Remaining')).to.be.true;",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/estatisticas",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"estatisticas"
							]
						}
					},
					"response": []
				},
				{
					"name": "End-to-End Dashboard Flow",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// This test simulates a complete dashboard loading flow",
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Commission data structure valid\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data.periodo).to.exist;",
									"    pm.expect(jsonData.data.resumo).to.exist;",
									"    pm.expect(jsonData.data.porContrato).to.be.an('array');",
									"});",
									"",
									"pm.test(\"Financial calculations correct\", function () {",
									"    const jsonData = pm.response.json();",
									"    const resumo = jsonData.data.resumo;",
									"    ",
									"    pm.expect(resumo.totalComissoes).to.be.a('number');",
									"    pm.expect(resumo.totalVendas).to.be.a('number');",
									"    pm.expect(resumo.numeroTransacoes).to.be.a('number');",
									"    ",
									"    // Basic validation: commissions should be less than total sales",
									"    if (resumo.totalVendas > 0) {",
									"        pm.expect(resumo.totalComissoes).to.be.lessThan(resumo.totalVendas);",
									"    }",
									"});",
									"",
									"pm.test(\"Performance optimized\", function () {",
									"    pm.expect(pm.response.responseTime).to.be.below(1000);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/comissoes?inicio=2024-01-01&fim=2024-12-31",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"comissoes"
							],
							"query": [
								{
									"key": "inicio",
									"value": "2024-01-01"
								},
								{
									"key": "fim",
									"value": "2024-12-31"
								}
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Error Handling Tests",
			"item": [
				{
					"name": "Rate Limit Error Response",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// This test may pass (200) or fail (429) depending on current rate limit state",
									"pm.test(\"Response is valid\", function () {",
									"    pm.expect([200, 429]).to.include(pm.response.code);",
									"});",
									"",
									"if (pm.response.code === 429) {",
									"    pm.test(\"Rate limit error properly formatted\", function () {",
									"        const jsonData = pm.response.json();",
									"        pm.expect(jsonData.success).to.be.false;",
									"        pm.expect(jsonData.message).to.exist;",
									"        pm.expect(pm.response.headers.has('X-RateLimit-Retry-After')).to.be.true;",
									"    });",
									"    ",
									"    pm.test(\"Retry-After header is numeric\", function () {",
									"        const retryAfter = pm.response.headers.get('X-RateLimit-Retry-After');",
									"        pm.expect(parseInt(retryAfter)).to.be.a('number');",
									"        pm.expect(parseInt(retryAfter)).to.be.greaterThan(0);",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/vencendo?dias=30",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"vencendo"
							],
							"query": [
								{
									"key": "dias",
									"value": "30"
								}
							]
						}
					},
					"response": []
				},
				{
					"name": "Invalid Parameters Handling",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 400\", function () {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test(\"Error message is clear\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.false;",
									"    pm.expect(jsonData.message).to.exist;",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{adminToken}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/contratos/comissoes?inicio=2024-12-31&fim=2024-01-01",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"contratos",
								"comissoes"
							],
							"query": [
								{
									"key": "inicio",
									"value": "2024-12-31"
								},
								{
									"key": "fim",
									"value": "2024-01-01"
								}
							]
						}
					},
					"response": []
				}
			]
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Set up test environment",
					"if (!pm.globals.has('testRunId')) {",
					"    pm.globals.set('testRunId', Date.now().toString());",
					"}",
					"",
					"// Log test execution",
					"console.log(`Executing: ${pm.info.requestName} at ${new Date().toISOString()}`);"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Global test logging",
					"const testRunId = pm.globals.get('testRunId');",
					"const requestName = pm.info.requestName;",
					"const responseTime = pm.response.responseTime;",
					"const statusCode = pm.response.code;",
					"",
					"console.log(`Test completed: ${requestName} - ${statusCode} - ${responseTime}ms`);"
				]
			}
		}
	],
	"variable": [
		{
			"key": "baseUrl",
			"value": "http://localhost:8080/api",
			"type": "string"
		},
		{
			"key": "adminToken",
			"value": "your-admin-jwt-token-here",
			"type": "string"
		},
		{
			"key": "userToken",
			"value": "your-user-jwt-token-here",
			"type": "string"
		}
	]
}