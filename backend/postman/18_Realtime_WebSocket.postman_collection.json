{
	"info": {
		"_postman_id": "realtime-websocket-collection-id",
		"name": "18 - Realtime/WebSocket",
		"description": "Collection para testes de funcionalidades em tempo real via WebSocket e Server-Sent Events.\n\n**Funcionalidades cobertas:**\n- Conexão WebSocket\n- Subscrição a leilões\n- Notificações de novos lances\n- Atualizações de status de produtos\n- Notificações de sistema\n- Heartbeat/Keep-alive\n- Desconexão limpa\n\n**Eventos WebSocket:**\n- NEW_BID: Novo lance em produto\n- AUCTION_ENDING: Leilão terminando\n- PRODUCT_STATUS_CHANGE: Mudança de status\n- USER_NOTIFICATION: Notificação pessoal\n- SYSTEM_ANNOUNCEMENT: Anúncio do sistema\n\n**Nota:** Postman tem limitações para WebSocket. Use ferramentas específicas para testes completos.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Obter Token WebSocket",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"WebSocket token received\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data).to.have.property('ws_token');",
							"    pm.expect(jsonData.data).to.have.property('ws_url');",
							"    pm.expect(jsonData.data).to.have.property('expires_at');",
							"    ",
							"    // Salvar token WebSocket",
							"    pm.environment.set('wsToken', jsonData.data.ws_token);",
							"    pm.environment.set('wsUrl', jsonData.data.ws_url);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "{{contentType}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"subscriptions\": [\n        \"NEW_BID\",\n        \"AUCTION_ENDING\",\n        \"USER_NOTIFICATION\"\n    ],\n    \"filters\": {\n        \"produtos\": [\"{{produtoId}}\"],\n        \"categorias\": [\"Eletrônicos\"]\n    }\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/realtime/ws-token",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"realtime",
						"ws-token"
					]
				},
				"description": "Obtém token de autenticação para conexão WebSocket."
			}
		},
		{
			"name": "Informações de Conexão WebSocket",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"WebSocket connection info\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data).to.have.property('ws_endpoint');",
							"    pm.expect(jsonData.data).to.have.property('supported_events');",
							"    pm.expect(jsonData.data).to.have.property('connection_params');",
							"    pm.expect(jsonData.data).to.have.property('heartbeat_interval');",
							"    pm.expect(jsonData.data.supported_events).to.be.an('array');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/api/realtime/info",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"realtime",
						"info"
					]
				},
				"description": "Obtém informações sobre conexão WebSocket e eventos suportados."
			}
		},
		{
			"name": "Simular Evento - Novo Lance",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Event simulated successfully\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data).to.have.property('event_sent');",
							"    pm.expect(jsonData.data).to.have.property('subscribers_notified');",
							"    pm.expect(jsonData.data.event_sent).to.be.true;",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "{{contentType}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"event_type\": \"NEW_BID\",\n    \"data\": {\n        \"produto_id\": \"{{produtoId}}\",\n        \"lance_id\": \"test-lance-id-123\",\n        \"new_price\": 3500.00,\n        \"previous_price\": 3250.00,\n        \"bidder_name\": \"Usuário Anônimo\",\n        \"timestamp\": \"2024-12-19T15:30:00Z\",\n        \"total_bids\": 6\n    },\n    \"target_users\": [\"{{compradorId}}\", \"{{vendedorId}}\"],\n    \"broadcast\": false\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/realtime/simulate-event",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"realtime",
						"simulate-event"
					]
				},
				"description": "Simula um evento de novo lance para testes de WebSocket."
			}
		},
		{
			"name": "Simular Evento - Leilão Terminando",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Auction ending event sent\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data.event_sent).to.be.true;",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "{{contentType}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"event_type\": \"AUCTION_ENDING\",\n    \"data\": {\n        \"produto_id\": \"{{produtoId}}\",\n        \"title\": \"Smartphone Samsung Galaxy S23 Ultra\",\n        \"current_price\": 3500.00,\n        \"time_remaining\": \"00:15:30\",\n        \"time_remaining_seconds\": 930,\n        \"is_winning\": true,\n        \"winning_bidder\": \"Você\"\n    },\n    \"target_users\": [\"{{compradorId}}\"],\n    \"broadcast\": false\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/realtime/simulate-event",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"realtime",
						"simulate-event"
					]
				},
				"description": "Simula evento de leilão terminando em breve."
			}
		},
		{
			"name": "Simular Evento - Mudança de Status",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Status change event sent\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data.event_sent).to.be.true;",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "{{contentType}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"event_type\": \"PRODUCT_STATUS_CHANGE\",\n    \"data\": {\n        \"produto_id\": \"990e8400-e29b-41d4-a716-446655440009\",\n        \"title\": \"iPhone 13 Pro 128GB\",\n        \"old_status\": \"ACTIVE\",\n        \"new_status\": \"SOLD\",\n        \"final_price\": 2450.00,\n        \"winner\": \"Marcos Antonio Pereira\",\n        \"ended_at\": \"2024-12-19T15:45:00Z\"\n    },\n    \"broadcast\": true\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/realtime/simulate-event",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"realtime",
						"simulate-event"
					]
				},
				"description": "Simula mudança de status de produto (ex: ACTIVE para SOLD)."
			}
		},
		{
			"name": "Simular Notificação de Sistema",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"System notification sent\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data.event_sent).to.be.true;",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "{{contentType}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"event_type\": \"SYSTEM_ANNOUNCEMENT\",\n    \"data\": {\n        \"title\": \"Manutenção Programada\",\n        \"message\": \"O sistema entrará em manutenção às 02:00 de amanhã por aproximadamente 30 minutos.\",\n        \"type\": \"INFO\",\n        \"priority\": \"MEDIUM\",\n        \"expires_at\": \"2024-12-20T02:30:00Z\",\n        \"action_url\": null\n    },\n    \"broadcast\": true\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/realtime/simulate-event",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"realtime",
						"simulate-event"
					]
				},
				"description": "Simula anúncio do sistema para todos os usuários conectados."
			}
		},
		{
			"name": "Listar Conexões Ativas",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Active connections listed\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data).to.have.property('total_connections');",
							"    pm.expect(jsonData.data).to.have.property('connections');",
							"    pm.expect(jsonData.data.connections).to.be.an('array');",
							"});",
							"",
							"pm.test(\"Connection info has required fields\", function () {",
							"    const jsonData = pm.response.json();",
							"    if (jsonData.data.connections.length > 0) {",
							"        const firstConnection = jsonData.data.connections[0];",
							"        pm.expect(firstConnection).to.have.property('connection_id');",
							"        pm.expect(firstConnection).to.have.property('user_id');",
							"        pm.expect(firstConnection).to.have.property('connected_at');",
							"        pm.expect(firstConnection).to.have.property('last_activity');",
							"        pm.expect(firstConnection).to.have.property('subscriptions');",
							"    }",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/api/admin/realtime/connections",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"admin",
						"realtime",
						"connections"
					]
				},
				"description": "Lista todas as conexões WebSocket ativas (admin only)."
			}
		},
		{
			"name": "Estatísticas de Tempo Real",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Realtime statistics available\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data).to.have.property('total_connections');",
							"    pm.expect(jsonData.data).to.have.property('events_sent_today');",
							"    pm.expect(jsonData.data).to.have.property('events_by_type');",
							"    pm.expect(jsonData.data).to.have.property('average_connection_time');",
							"    pm.expect(jsonData.data).to.have.property('peak_connections_today');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/api/admin/realtime/statistics",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"admin",
						"realtime",
						"statistics"
					]
				},
				"description": "Obtém estatísticas do sistema de tempo real (admin only)."
			}
		},
		{
			"name": "Desconectar Usuário",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"User disconnected successfully\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data).to.have.property('disconnected_connections');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "{{contentType}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"user_id\": \"550e8400-e29b-41d4-a716-446655440050\",\n    \"reason\": \"Usuário bloqueado por tentativas excessivas de login\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/admin/realtime/disconnect-user",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"admin",
						"realtime",
						"disconnect-user"
					]
				},
				"description": "Força desconexão de um usuário específico (admin only)."
			}
		},
		{
			"name": "Broadcast para Todos",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Broadcast sent successfully\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data).to.have.property('recipients_count');",
							"    pm.expect(jsonData.data).to.have.property('message_sent');",
							"    pm.expect(jsonData.data.message_sent).to.be.true;",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "{{contentType}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"event_type\": \"SYSTEM_ANNOUNCEMENT\",\n    \"title\": \"Novo Lote Disponível!\",\n    \"message\": \"Um novo lote com produtos de eletrônicos foi adicionado. Confira agora!\",\n    \"priority\": \"HIGH\",\n    \"type\": \"SUCCESS\",\n    \"action_url\": \"/lotes/novo-lote-eletronicos\",\n    \"expires_in_minutes\": 60\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/admin/realtime/broadcast",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"admin",
						"realtime",
						"broadcast"
					]
				},
				"description": "Envia mensagem broadcast para todos os usuários conectados (admin only)."
			}
		},
		{
			"name": "Server-Sent Events - Endpoint",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"SSE headers present\", function () {",
							"    pm.expect(pm.response.headers.get('Content-Type')).to.include('text/event-stream');",
							"    pm.expect(pm.response.headers.get('Cache-Control')).to.equal('no-cache');",
							"    pm.expect(pm.response.headers.get('Connection')).to.equal('keep-alive');",
							"});",
							"",
							"pm.test(\"SSE data format\", function () {",
							"    const responseText = pm.response.text();",
							"    pm.expect(responseText).to.include('data:');",
							"    pm.expect(responseText).to.include('event:');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "text/event-stream",
						"type": "text"
					},
					{
						"key": "Cache-Control",
						"value": "no-cache",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/api/realtime/sse?produtos={{produtoId}}&events=NEW_BID,AUCTION_ENDING",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"realtime",
						"sse"
					],
					"query": [
						{
							"key": "produtos",
							"value": "{{produtoId}}"
						},
						{
							"key": "events",
							"value": "NEW_BID,AUCTION_ENDING"
						}
					]
				},
				"description": "Endpoint para Server-Sent Events como alternativa ao WebSocket."
			}
		},
		{
			"name": "Teste de Heartbeat",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Heartbeat response\", function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"    pm.expect(jsonData.data).to.have.property('timestamp');",
							"    pm.expect(jsonData.data).to.have.property('server_time');",
							"    pm.expect(jsonData.data).to.have.property('connection_status');",
							"});",
							"",
							"pm.test(\"Response time is fast\", function () {",
							"    pm.expect(pm.response.responseTime).to.be.below(500);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{authToken}}",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "{{acceptType}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/api/realtime/heartbeat",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"realtime",
						"heartbeat"
					]
				},
				"description": "Endpoint de heartbeat para manter conexão ativa."
			}
		}
	],
	"auth": {
		"type": "bearer",
		"bearer": [
			{
				"key": "token",
				"value": "{{authToken}}",
				"type": "string"
			}
		]
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script para preparar testes de tempo real",
					"console.log('Preparando teste de tempo real...');",
					"",
					"// Verificar se tem token de autenticação",
					"const authToken = pm.environment.get('authToken');",
					"if (!authToken && pm.request.url.toString().includes('/admin/')) {",
					"    console.log('Token de admin necessário para este endpoint.');",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script global para testes de tempo real",
					"console.log('Teste de tempo real executado:', pm.response.code);",
					"",
					"// Log de eventos simulados",
					"if (pm.response.code === 200 && pm.request.url.toString().includes('simulate-event')) {",
					"    const jsonData = pm.response.json();",
					"    if (jsonData.success && jsonData.data.event_sent) {",
					"        console.log('Evento simulado enviado com sucesso para', jsonData.data.subscribers_notified || 'broadcast', 'usuários');",
					"    }",
					"}"
				]
			}
		}
	]
}