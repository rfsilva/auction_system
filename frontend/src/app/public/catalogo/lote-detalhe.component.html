<!-- HIST√ìRIA 03: P√°gina de Detalhes do Lote e Lista de Produtos V√°lidos -->
<!-- CORRIGIDO: Template atualizado para usar c√°lculo pr√≥prio de status -->
<!-- ADICIONADO: Formata√ß√£o de dimens√µes JSON para exibi√ß√£o leg√≠vel -->
<div class="lote-detalhe-container">
  
  <!-- Breadcrumb -->
  <nav class="breadcrumb" aria-label="Navega√ß√£o">
    <ol class="breadcrumb-list">
      <li class="breadcrumb-item">
        <a routerLink="/catalogo" class="breadcrumb-link">Cat√°logo</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ lote?.title || 'Detalhes do Lote' }}
      </li>
    </ol>
  </nav>

  <!-- Loading do Lote -->
  <div *ngIf="loadingLote" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Carregando detalhes do lote...</p>
  </div>

  <!-- Erro ao carregar lote -->
  <div *ngIf="error && !loadingLote" class="error-container">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h2 class="error-title">Lote n√£o encontrado</h2>
    <p class="error-message">{{ error }}</p>
    <button type="button" class="btn btn-primary" (click)="voltarParaCatalogo()">
      Voltar ao Cat√°logo
    </button>
  </div>

  <!-- Conte√∫do principal -->
  <div *ngIf="lote && !loadingLote && !error" class="lote-content">
    
    <!-- Cabe√ßalho do Lote -->
    <header class="lote-header">
      <div class="lote-header-content">
        <div class="lote-info">
          <h1 class="lote-title">{{ lote.title }}</h1>
          
          <div class="lote-meta">
            <span class="lote-status" [ngClass]="getStatusClass(lote.status)">
              {{ getStatusText(lote.status) }}
            </span>
            
            <span *ngIf="lote.categoria" class="lote-categoria">
              üìÇ {{ lote.categoria }}
            </span>
            
            <span *ngIf="lote.sellerCompanyName" class="lote-vendedor">
              üè¢ {{ lote.sellerCompanyName }}
            </span>
          </div>

          <div class="lote-stats">
            <div class="stat-item">
              <span class="stat-label">Produtos v√°lidos:</span>
              <span class="stat-value">{{ lote.totalProdutos }}</span>
            </div>
            
            <!-- CORRIGIDO: Usar c√°lculo pr√≥prio para verificar se lote est√° ativo -->
            <div class="stat-item" *ngIf="loteAtivo">
              <span class="stat-label">Tempo restante:</span>
              <!-- CORRIGIDO: Usar tempo calculado localmente -->
              <span class="stat-value time-remaining" 
                    [ngClass]="{'urgent': getTempoRestanteCalculado() < 3600}">
                {{ formatarTempoRestante(getTempoRestanteCalculado()) }}
              </span>
            </div>
            
            <div class="stat-item">
              <span class="stat-label">Encerramento:</span>
              <span class="stat-value">{{ formatarData(lote.loteEndDateTime) }}</span>
            </div>
          </div>
        </div>

        <!-- Imagem destaque do lote -->
        <div class="lote-image" *ngIf="lote.imagemDestaque">
          <img [src]="lote.imagemDestaque" 
               [alt]="lote.title"
               class="lote-image-img"
               loading="lazy">
        </div>
      </div>
    </header>

    <!-- Descri√ß√£o do Lote -->
    <section class="lote-description" *ngIf="lote.description">
      <h2 class="section-title">Descri√ß√£o do Lote</h2>
      <div class="description-content">
        <p>{{ lote.description }}</p>
      </div>
    </section>

    <!-- Se√ß√£o de Produtos -->
    <section class="produtos-section">
      <div class="produtos-header">
        <h2 class="section-title">
          Produtos do Lote
          <span class="produtos-count" *ngIf="totalElements > 0">
            ({{ totalElements }} {{ totalElements === 1 ? 'produto' : 'produtos' }})
          </span>
        </h2>

        <!-- Controles de pagina√ß√£o superior -->
        <div class="pagination-controls" *ngIf="temPaginacao">
          <div class="page-size-selector">
            <label for="pageSize" class="page-size-label">Produtos por p√°gina:</label>
            <select id="pageSize" 
                    [value]="pageSize" 
                    (change)="alterarTamanhoPagina($event)"
                    class="page-size-select">
              <option *ngFor="let size of pageSizeOptions" [value]="size">
                {{ size }}
              </option>
            </select>
          </div>

          <div class="page-info">
            {{ paginaInfo }}
          </div>
        </div>
      </div>

      <!-- Loading dos produtos -->
      <div *ngIf="loadingProdutos" class="loading-produtos">
        <div class="loading-spinner-small"></div>
        <span>Carregando produtos...</span>
      </div>

      <!-- Erro ao carregar produtos -->
      <div *ngIf="errorProdutos && !loadingProdutos" class="error-produtos">
        <div class="error-icon-small">‚ö†Ô∏è</div>
        <span>{{ errorProdutos }}</span>
        <button type="button" class="btn btn-sm btn-outline" (click)="carregarProdutos()">
          Tentar novamente
        </button>
      </div>

      <!-- Lista de produtos -->
      <div *ngIf="temProdutos && !loadingProdutos && !errorProdutos" class="produtos-grid">
        <div *ngFor="let produto of produtos; trackBy: trackByProdutoId" 
             class="produto-card">
          
          <!-- Imagem do produto -->
          <div class="produto-image-container">
            <!-- CORRIGIDO: Usando as propriedades corretas do ProdutoImageComponent -->
            <app-produto-image 
              [src]="obterPrimeiraImagem(produto.images)"
              [alt]="produto.title"
              [height]="200"
              class="produto-image">
            </app-produto-image>
            
            <div class="produto-status-badge" [ngClass]="getStatusClass(produto.status)">
              {{ getStatusText(produto.status) }}
            </div>
          </div>

          <!-- Informa√ß√µes do produto -->
          <div class="produto-info">
            <h3 class="produto-title">{{ produto.title }}</h3>
            
            <p class="produto-description" *ngIf="produto.description">
              {{ produto.description.length > 100 ? 
                  (produto.description | slice:0:100) + '...' : 
                  produto.description }}
            </p>

            <div class="produto-precos">
              <div class="preco-atual">
                <span class="preco-label">Pre√ßo atual:</span>
                <span class="preco-valor">{{ formatarPreco(produto.currentPrice) }}</span>
              </div>
              
              <div class="preco-inicial" *ngIf="produto.currentPrice !== produto.initialPrice">
                <span class="preco-label">Pre√ßo inicial:</span>
                <span class="preco-valor">{{ formatarPreco(produto.initialPrice) }}</span>
              </div>
            </div>

            <div class="produto-meta">
              <div class="meta-item" *ngIf="produto.categoria">
                <span class="meta-label">Categoria:</span>
                <span class="meta-value">{{ produto.categoria }}</span>
              </div>
              
              <div class="meta-item" *ngIf="produto.weight">
                <span class="meta-label">Peso:</span>
                <span class="meta-value">{{ produto.weight }}kg</span>
              </div>
              
              <!-- CORRIGIDO: Usar formata√ß√£o de dimens√µes ao inv√©s de exibir JSON bruto -->
              <div class="meta-item" *ngIf="formatarDimensoes(produto.dimensions)">
                <span class="meta-label">Dimens√µes:</span>
                <span class="meta-value">{{ formatarDimensoes(produto.dimensions) }}</span>
              </div>
            </div>

            <!-- CORRIGIDO: Para produtos, ainda podemos usar os campos do backend pois eles s√£o calculados corretamente -->
            <div class="produto-tempo" *ngIf="produto.isActive && !produto.isExpired">
              <span class="tempo-label">Tempo restante:</span>
              <span class="tempo-valor" 
                    [ngClass]="{'urgent': produto.timeRemaining < 3600}">
                {{ formatarTempoRestante(produto.timeRemaining) }}
              </span>
            </div>

            <!-- Tags do produto -->
            <div class="produto-tags" *ngIf="produto.tags && produto.tags.length > 0">
              <span *ngFor="let tag of produto.tags" class="tag">
                {{ tag }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensagem quando n√£o h√° produtos -->
      <div *ngIf="!temProdutos && !loadingProdutos && !errorProdutos" class="no-produtos">
        <div class="no-produtos-icon">üì¶</div>
        <h3 class="no-produtos-title">Nenhum produto v√°lido</h3>
        <p class="no-produtos-message">
          Este lote n√£o possui produtos v√°lidos para exibi√ß√£o no momento.
        </p>
      </div>

      <!-- Pagina√ß√£o inferior -->
      <nav class="pagination-nav" *ngIf="temPaginacao && temProdutos" aria-label="Navega√ß√£o de produtos">
        <div class="pagination-info">
          {{ paginaInfo }}
        </div>

        <div class="pagination-controls-bottom">
          <!-- Bot√£o p√°gina anterior -->
          <button type="button" 
                  class="btn btn-pagination" 
                  [disabled]="currentPage === 0"
                  (click)="paginaAnterior()"
                  aria-label="P√°gina anterior">
            ‚Üê Anterior
          </button>

          <!-- N√∫meros das p√°ginas -->
          <div class="pagination-numbers">
            <button *ngFor="let page of getPaginationPages(); trackBy: trackByPageNumber"
                    type="button"
                    class="btn btn-page-number"
                    [class.active]="page === currentPage"
                    (click)="irParaPagina(page)"
                    [attr.aria-label]="'Ir para p√°gina ' + (page + 1)"
                    [attr.aria-current]="page === currentPage ? 'page' : null">
              {{ page + 1 }}
            </button>
          </div>

          <!-- Bot√£o pr√≥xima p√°gina -->
          <button type="button" 
                  class="btn btn-pagination" 
                  [disabled]="currentPage >= totalPages - 1"
                  (click)="proximaPagina()"
                  aria-label="Pr√≥xima p√°gina">
            Pr√≥xima ‚Üí
          </button>
        </div>
      </nav>
    </section>

    <!-- Bot√£o voltar -->
    <div class="actions-footer">
      <button type="button" class="btn btn-secondary" (click)="voltarParaCatalogo()">
        ‚Üê Voltar ao Cat√°logo
      </button>
    </div>
  </div>
</div>