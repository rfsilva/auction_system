<!-- Ativar Vendedor Component -->
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="h4 mb-1">Ativar Vendedor</h2>
          <p class="text-muted mb-0">Transforme um usuário em vendedor através de um contrato</p>
        </div>
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="cancelar()"
          [disabled]="loading">
          <i class="fas fa-arrow-left me-2"></i>
          Voltar
        </button>
      </div>

      <!-- Mensagens de erro/sucesso -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ errorMessage }}
        <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
      </div>

      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        {{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = ''"></button>
      </div>

      <!-- Erros de validação -->
      <div *ngIf="hasValidationErrors()" class="alert alert-warning">
        <h6><i class="fas fa-exclamation-triangle me-2"></i>Corrija os seguintes erros:</h6>
        <ul class="mb-0">
          <li *ngFor="let error of validationErrors">{{ error }}</li>
        </ul>
      </div>

      <!-- Formulário -->
      <div class="card">
        <div class="card-body">
          <form [formGroup]="form" (ngSubmit)="onSubmit()">
            
            <!-- Seção 1: Seleção do Usuário -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="card-title mb-3">
                  <i class="fas fa-user me-2"></i>
                  1. Selecionar Usuário
                </h5>
                
                <!-- Busca de usuário -->
                <div class="mb-3">
                  <label for="usuarioBusca" class="form-label">
                    Buscar usuário <span class="text-danger">*</span>
                  </label>
                  <div class="position-relative">
                    <input
                      type="text"
                      id="usuarioBusca"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('usuarioBusca')"
                      formControlName="usuarioBusca"
                      placeholder="Digite nome ou email do usuário..."
                      autocomplete="off">
                    
                    <div *ngIf="buscandoUsuarios" class="position-absolute top-50 end-0 translate-middle-y me-3">
                      <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Buscando...</span>
                      </div>
                    </div>

                    <!-- Lista de sugestões -->
                    <div *ngIf="usuarios.length > 0" class="dropdown-menu show w-100 mt-1" style="max-height: 300px; overflow-y: auto;">
                      <div 
                        *ngFor="let usuario of usuarios" 
                        class="dropdown-item cursor-pointer"
                        (click)="selecionarUsuario(usuario)">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <div class="fw-medium">{{ usuario.nome }}</div>
                            <small class="text-muted">{{ usuario.email }}</small>
                            <div *ngIf="usuario.telefone" class="small text-muted">{{ usuario.telefone }}</div>
                          </div>
                          <div class="text-end">
                            <span *ngIf="usuario.isVendedor" class="badge bg-success">Vendedor</span>
                            <span *ngIf="usuario.temContratoAtivo" class="badge bg-primary">Contrato Ativo</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div *ngIf="isFieldInvalid('usuarioBusca')" class="invalid-feedback d-block">
                    {{ getFieldError('usuarioBusca') }}
                  </div>
                </div>

                <!-- Usuário selecionado -->
                <div *ngIf="usuarioSelecionado" class="card bg-light">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="card-title mb-1">{{ usuarioSelecionado.nome }}</h6>
                        <p class="card-text mb-1">
                          <i class="fas fa-envelope me-2"></i>{{ usuarioSelecionado.email }}
                        </p>
                        <p *ngIf="usuarioSelecionado.telefone" class="card-text mb-1">
                          <i class="fas fa-phone me-2"></i>{{ usuarioSelecionado.telefone }}
                        </p>
                        <div class="mt-2">
                          <span *ngIf="usuarioSelecionado.isVendedor" class="badge bg-success me-2">Vendedor</span>
                          <span *ngIf="usuarioSelecionado.temContratoAtivo" class="badge bg-primary">Contrato Ativo</span>
                          <span *ngIf="!usuarioSelecionado.isVendedor" class="badge bg-secondary">Usuário Comum</span>
                        </div>
                      </div>
                      <button 
                        type="button" 
                        class="btn btn-sm btn-outline-danger"
                        (click)="limparSelecao()">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Seção 2: Dados do Contrato -->
            <div class="row mb-4" *ngIf="usuarioSelecionado">
              <div class="col-12">
                <h5 class="card-title mb-3">
                  <i class="fas fa-file-contract me-2"></i>
                  2. Dados do Contrato
                </h5>
                
                <div class="row">
                  <!-- Taxa de comissão -->
                  <div class="col-md-6 mb-3">
                    <label for="feeRate" class="form-label">
                      Taxa de comissão <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                      <input
                        type="number"
                        id="feeRate"
                        class="form-control"
                        [class.is-invalid]="isFieldInvalid('feeRate')"
                        formControlName="feeRate"
                        step="0.0001"
                        min="0.0001"
                        max="0.5"
                        placeholder="0.05">
                      <span class="input-group-text">
                        {{ formatarTaxa(form.get('feeRate')?.value || 0) }}
                      </span>
                    </div>
                    <div class="form-text">Entre 0.01% e 50%</div>
                    <div *ngIf="isFieldInvalid('feeRate')" class="invalid-feedback d-block">
                      {{ getFieldError('feeRate') }}
                    </div>
                  </div>

                  <!-- Categoria -->
                  <div class="col-md-6 mb-3">
                    <label for="categoria" class="form-label">Categoria específica</label>
                    <select
                      id="categoria"
                      class="form-select"
                      formControlName="categoria">
                      <option value="">Todas as categorias</option>
                      <option *ngFor="let categoria of categorias" [value]="categoria">
                        {{ categoria }}
                      </option>
                    </select>
                    <div class="form-text">Deixe vazio para permitir todas as categorias</div>
                  </div>
                </div>

                <div class="row">
                  <!-- Data de início -->
                  <div class="col-md-6 mb-3">
                    <label for="validFrom" class="form-label">
                      Data de início <span class="text-danger">*</span>
                    </label>
                    <input
                      type="date"
                      id="validFrom"
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('validFrom')"
                      formControlName="validFrom">
                    <div *ngIf="isFieldInvalid('validFrom')" class="invalid-feedback d-block">
                      {{ getFieldError('validFrom') }}
                    </div>
                  </div>

                  <!-- Data de fim -->
                  <div class="col-md-6 mb-3">
                    <label for="validTo" class="form-label">Data de fim</label>
                    <input
                      type="date"
                      id="validTo"
                      class="form-control"
                      formControlName="validTo">
                    <div class="form-text">Deixe vazio para contrato sem data de expiração</div>
                  </div>
                </div>

                <!-- Termos do contrato -->
                <div class="mb-3">
                  <label for="terms" class="form-label">
                    Termos do contrato <span class="text-danger">*</span>
                  </label>
                  <textarea
                    id="terms"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('terms')"
                    formControlName="terms"
                    rows="4"
                    placeholder="Descreva os termos e condições do contrato..."></textarea>
                  <div *ngIf="isFieldInvalid('terms')" class="invalid-feedback d-block">
                    {{ getFieldError('terms') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Seção 3: Opções -->
            <div class="row mb-4" *ngIf="usuarioSelecionado">
              <div class="col-12">
                <h5 class="card-title mb-3">
                  <i class="fas fa-cog me-2"></i>
                  3. Opções de Ativação
                </h5>
                
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="ativarImediatamente"
                    formControlName="ativarImediatamente">
                  <label class="form-check-label" for="ativarImediatamente">
                    <strong>Ativar contrato imediatamente</strong>
                  </label>
                  <div class="form-text">
                    Se marcado, o usuário se tornará vendedor imediatamente. 
                    Caso contrário, o contrato ficará em rascunho para ativação posterior.
                  </div>
                </div>
              </div>
            </div>

            <!-- Botões de ação -->
            <div class="d-flex justify-content-end gap-2">
              <button 
                type="button" 
                class="btn btn-outline-secondary"
                (click)="cancelar()"
                [disabled]="loading">
                Cancelar
              </button>
              
              <button 
                type="submit" 
                class="btn btn-primary"
                [disabled]="loading || form.invalid || !usuarioSelecionado">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                <i *ngIf="!loading" class="fas fa-save me-2"></i>
                {{ form.get('ativarImediatamente')?.value ? 'Criar e Ativar Contrato' : 'Criar Contrato' }}
              </button>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>
</div>